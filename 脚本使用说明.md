## 数据库初始化脚本与使用说明

### 项目结构
```
src/main/resources/db/
├── init/
│   ├── schema.sql          # 表结构定义
│   └── data.sql            # 测试数据
└── migration/              # 版本迁移脚本（未来扩展）
```

## 1. 表结构脚本 (schema.sql)

```sql
-- 课程管理系统数据库表结构
-- 适用于 H2 (开发环境) 和 MySQL (生产环境)

-- 创建学生表
CREATE TABLE IF NOT EXISTS students (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    student_id VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(50) NOT NULL,
    major VARCHAR(50),
    grade INT,
    email VARCHAR(100) UNIQUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- 索引
    INDEX idx_student_major (major),
    INDEX idx_student_grade (grade)
);

-- 创建课程表
CREATE TABLE IF NOT EXISTS courses (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    code VARCHAR(20) NOT NULL UNIQUE,
    title VARCHAR(100) NOT NULL,
    instructor_name VARCHAR(100),
    instructor_email VARCHAR(100),
    schedule_day VARCHAR(20),
    schedule_start_time VARCHAR(10),
    schedule_end_time VARCHAR(10),
    expected_attendance INT,
    capacity INT NOT NULL DEFAULT 0,
    enrolled INT DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- 索引
    INDEX idx_course_instructor (instructor_name),
    INDEX idx_course_title (title)
);

-- 创建选课表
CREATE TABLE IF NOT EXISTS enrollments (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    course_id BIGINT NOT NULL,
    student_id BIGINT NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    enrolled_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 唯一约束，防止重复选课
    UNIQUE KEY uk_course_student (course_id, student_id),

    -- 外键约束
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE,
    FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE,

    -- 索引
    INDEX idx_enrollment_student (student_id),
    INDEX idx_enrollment_course (course_id),
    INDEX idx_enrollment_status (status)
);
```

## 2. 测试数据脚本 (data.sql)

```sql
-- 课程管理系统测试数据
-- 清空现有数据（可选）
-- DELETE FROM enrollments;
-- DELETE FROM courses;
-- DELETE FROM students;

-- 插入学生数据 (匹配实体类字段)
INSERT INTO students (student_id, name, major, grade, email, created_at) VALUES
('2023001001', '张三', '计算机科学', 3, 'zhangsan@zjsu.edu.cn', NOW()),
('2023001002', '李四', '计算机科学', 3, 'lisi@zjsu.edu.cn', NOW()),
('2023001003', '王五', '计算机科学', 3, 'wangwu@zjsu.edu.cn', NOW()),
('2023002001', '赵六', '软件工程', 2, 'zhaoliu@zjsu.edu.cn', NOW()),
('2023002002', '钱七', '软件工程', 2, 'qianqi@zjsu.edu.cn', NOW()),
('2023003001', '孙八', '数据科学', 4, 'sunba@zjsu.edu.cn', NOW()),
('2023003002', '周九', '数据科学', 4, 'zhoujiu@zjsu.edu.cn', NOW()),
('2023004001', '吴十', '人工智能', 1, 'wushi@zjsu.edu.cn', NOW());

-- 插入课程数据 (匹配实体类字段)
INSERT INTO courses (code, title, instructor_name, instructor_email, schedule_day, schedule_start_time, schedule_end_time, capacity, enrolled, created_at) VALUES
('CS101', 'Java程序设计', '张教授', 'zhang@zjsu.edu.cn', 'MONDAY', '08:00', '09:40', 50, 3, NOW()),
('CS102', '数据库原理', '李教授', 'li@zjsu.edu.cn', 'TUESDAY', '10:00', '11:40', 40, 2, NOW()),
('CS201', 'Web开发技术', '王教授', 'wang@zjsu.edu.cn', 'WEDNESDAY', '14:00', '15:40', 45, 2, NOW()),
('CS301', '人工智能基础', '赵教授', 'zhao@zjsu.edu.cn', 'THURSDAY', '16:00', '17:40', 35, 2, NOW()),
('MATH101', '高等数学', '钱教授', 'qian@zjsu.edu.cn', 'FRIDAY', '08:00', '09:40', 60, 1, NOW()),
('CS401', '分布式系统', '周教授', 'zhou@zjsu.edu.cn', 'MONDAY', '14:00', '15:40', 30, 2, NOW());

-- 插入选课数据
INSERT INTO enrollments (course_id, student_id, status, enrolled_at) VALUES
(1, 1, 'ACTIVE', NOW()),
(1, 2, 'ACTIVE', NOW()),
(1, 3, 'ACTIVE', NOW()),
(2, 1, 'ACTIVE', NOW()),
(2, 4, 'ACTIVE', NOW()),
(3, 2, 'ACTIVE', NOW()),
(3, 5, 'ACTIVE', NOW()),
(4, 6, 'ACTIVE', NOW()),
(4, 7, 'ACTIVE', NOW()),
(5, 8, 'ACTIVE', NOW()),
(6, 3, 'ACTIVE', NOW()),
(6, 7, 'ACTIVE', NOW());

-- 输出数据初始化完成信息
SELECT '测试数据初始化完成' AS message;
SELECT
    (SELECT COUNT(*) FROM students) AS student_count,
    (SELECT COUNT(*) FROM courses) AS course_count,
    (SELECT COUNT(*) FROM enrollments) AS enrollment_count;
```

## 3. 使用说明

### 开发环境 (H2) - 自动执行

**启动方式：**
```bash
# 默认启动开发环境
mvn spring-boot:run
# 或
java -jar target/course-0.0.1-SNAPSHOT.jar
```

**自动执行：**
- 应用启动时自动执行 `schema.sql` 和 `data.sql`
- 使用 H2 内存数据库，数据重启后清空
- H2 控制台：`http://localhost:8080/h2-console`
  - JDBC URL: `jdbc:h2:mem:course_dev`
  - 用户名: `sa`
  - 密码: (空)

### 生产环境 (MySQL) - 手动执行

**1. 创建数据库：**

```sql
CREATE DATABASE course_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**2. 执行表结构：**

```bash
mysql -u your_username -pyour_password --default-character-set=utf8mb4 --show-warnings course_db < src\main\resources\db\init\schema.sql
```

**3. 插入测试数据（可选）：**

```bash
mysql -u your_username -pyour_password --default-character-set=utf8mb4 course_db < src\main\resources\db\init\data.sql
```

**4. 启动生产环境：**

```bash
mvn spring-boot:run -Dspring-boot.run.profiles=prod
# 或
java -jar -Dspring.profiles.active=prod target/course-0.0.1-SNAPSHOT.jar
```

### 数据验证查询

**在 H2 控制台或 MySQL 客户端执行：**

```sql
-- 验证表结构
SHOW TABLES;

-- 验证数据完整性
SELECT * FROM course_enrollment_stats;

-- 验证初始化数据
SELECT 
    '学生数据' as type, COUNT(*) as count FROM students
UNION ALL
SELECT '课程数据', COUNT(*) FROM courses
UNION ALL
SELECT '选课数据', COUNT(*) FROM enrollments;

-- 验证唯一约束
SELECT student_id, COUNT(*) as duplicate_count 
FROM students 
GROUP BY student_id 
HAVING COUNT(*) > 1;

SELECT code, COUNT(*) as duplicate_count 
FROM courses 
GROUP BY code 
HAVING COUNT(*) > 1;

SELECT course_id, student_id, COUNT(*) as duplicate_count 
FROM enrollments 
GROUP BY course_id, student_id 
HAVING COUNT(*) > 1;
```

### 环境切换验证

**开发环境验证：**

```bash
scripts/verify-deployment.bat dev
```

**生产环境验证：**

```bash
# 先确保MySQL数据库已初始化
scripts/verify-deployment.bat prod
```

### 初始化数据内容

**学生数据 (8名)：**

- 计算机科学专业：3名（大三）
- 软件工程专业：2名（大二）
- 数据科学专业：2名（大四）
- 人工智能专业：1名（大一）

**课程数据 (6门)：**
- CS101: Java程序设计 (50人容量)
- CS102: 数据库原理 (40人容量)
- CS201: Web开发技术 (45人容量)
- CS301: 人工智能基础 (35人容量)
- MATH101: 高等数学 (60人容量)
- CS401: 分布式系统 (30人容量)

**选课数据 (12条)：**
- 覆盖所有学生和课程的活跃选课记录
- 自动更新课程已选人数

### 备份与恢复

**备份数据库：**
```bash
mysqldump -u username -p course_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

**恢复数据库：**

```bash
mysql -u username -p course_db < backup_file.sql
```

### 重置数据库

**完全重置：**
```sql
DROP DATABASE course_db;
CREATE DATABASE course_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
-- 重新执行初始化脚本
```

